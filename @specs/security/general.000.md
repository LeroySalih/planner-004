## Sign-in hardening

- **CSRF defenses**: `/signin` now issues a per-visit CSRF token cookie (`planner_csrf_token`, Secure, Lax, non-HttpOnly) and the form posts the token. `signinAction` compares the posted token to the cookie with `timingSafeEqual` and rejects if they mismatch. It also checks `Origin`/`Referer` hosts against `APP_URL`/`NEXT_PUBLIC_APP_URL` (plus the Host header) to block cross-site posts. Session cookies are set with `SameSite=Strict`, `HttpOnly`, and `Secure`.
- **Throttle/lockout**: Sign-in attempts are recorded in `sign_in_attempts` (email, IP, user_id, success, reason, attempted_at). Limits: 5 failed attempts per email in 15 minutes; 25 failed attempts per IP in 15 minutes. Exceeding either returns a generic error before password verification. Reasons include `invalid-payload`, `lookup-error`, `profile-not-found`, `invalid-password`, `throttled`, `csrf-mismatch`, `forbidden-origin`, or `null` on success.
- **Config**: Set `APP_URL` (and `NEXT_PUBLIC_APP_URL` if used) to the full origin (e.g., `http://localhost:3000` in dev, `https://dino.mr-salih.org` in prod) so origin checks pass. Run migration `migrations/applied/20251212_sign_in_attempts.sql` to create the audit/throttle table and indexes.
- **Signup enumeration**: Signup now returns a generic error for duplicate emails to avoid leaking which accounts exist. Specific reasons are logged server-side for observability; client sees a neutral failure message. Consider a small constant delay in the handler to reduce timing signals.
- **Session lifetime/binding**: Sessions now expire after 1 hour (rolling) instead of 30 days. Session validation checks stored user agent and IP; mismatches revoke the session and clear the cookie. Session cookies remain `HttpOnly`, `Secure`, `SameSite=Strict`.
- **Pending**: Password policy is still minimal (6+ chars) to avoid disrupting pupils; revisit with a pupil-friendly strength approach (e.g., passphrases) when feasible.
- **JWT consideration**: Chose not to use JWTs for client-server auth. Current model uses server-issued, httpOnly, Secure, SameSite=Strict session cookies with short TTL and IP/UA binding. JWTs would add key management and revocation complexity without benefit in this single-app setup. Re-evaluate only if we expose external APIs or need stateless tokens across services.
